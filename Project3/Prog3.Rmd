---
title: "Progetto III"
author: "Simone Manti, matricola: 566908"
date: "22/12/2021"
output: pdf_document
---

```{r setup, include=FALSE}
A = read.csv("RAILFRTINTERMODAL.csv", row.names = 1, stringsAsFactors = F)
ts = ts(A, deltat=1/12, start = c(2000,1))
ts.da = decompose(ts, type = "a")
ts.dm = decompose(ts, type = "m")
ts.dar=as.vector(window(ts.da$random,c(2000,7),c(2018,6)))
ts.dmr=as.vector(window(ts.dm$random,c(2000,7),c(2018,6)))
ts.hwa = HoltWinters(ts, seasonal = "a")
ts.hwm = HoltWinters(ts, seasonal = "m")
l=length(ts)
res.hwa=rep(0,24)
res.hwm=rep(0,24)
j=1
for(i in (l-24):(l-1)){
  ts_cv=ts(ts[1:i],frequency=12,start=c(2000,1))
  ts.hwa=HoltWinters(ts_cv,seasonal="additive")
  ts.hwm=HoltWinters(ts_cv,seasonal="multiplicative")
  ts.hwa.p=predict(ts.hwa,1)
  ts.hwm.p=predict(ts.hwm,1)
  res.hwa[j]=ts.hwa.p - ts[i+1]
  res.hwm[j]=ts.hwm.p - ts[i+1]
  j=j+1
}
```

\section{Introduzione}
La seguente analisi è rivolta alle aziende dedite alla costruzione di trasporti ferroviari per merci intermodali.
Analizzeremo una serie storica (dettagli in fondo alla relazione) riguardante il traffico ferroviario di merci
intermodali e il nostro obiettivo sarà predire il numero di unità nel 2019, in modo da costruire mezzi di
trasporto che siano sufficientemente capienti ed efficienti.

\section{Presentazione del problema}

Cominciamo l’analisi osservando una rappresentazione grafica della serie storica e la sua funzione di autocorrelazione.

```{r echo=FALSE, fig.show='hold', out.height="45%", out.width="45%", fig.align='center'}
plot(ts, main = "Unità merci intermodali per trasporti ferroviari")
acf(ts, 48, main = "ACF serie storica")
```

Prima di continuare, diamo alcuni chiarimenti sulla serie storica e facciamo alcune osservazioni.

\begin{enumerate}
\item La serie storica rappresenta il numero di unità di merci intermodali trasportate per via ferroviaria per
ogni mese, dal Gennaio 2000 al Dicembre 2018.
\item Guardando l’autocorrelazione osserviamo immediatamente la presenza di un trend e anche di stagionalità,
data la presenza di "picchi" in ogni periodo.
\end{enumerate}

\section{Decomposizione}

Procediamo la nostra analisi guardando come si comportano i metodi di decomposizione additivo e moltiplicativo
con stagionalità fissa.



```{r echo=FALSE, fig.show='hold', out.height="45%", out.width="45%", fig.align='center'}
plot(ts.da)
plot(ts.dm)
```

Osserviamo che il metodo di decomposizione additivo sembra catturare meglio la componente stagionale, in quanto le ordinate variano in $[10^{-5}, 10^5]$. Anche i residui però variano nello stesso intervallo, proviamo a
guardare la loro autocorrelazione e il loro plot per ambedue i metodi.

```{r echo=FALSE, fig.show='hold', out.height="45%", out.width="45%", fig.align='center'}
acf(ts.dar, main = "ACF residui decomposizione additiva")
acf(ts.dmr, main = "ACF residui decomposizione moltiplicativa")
```

```{r echo=FALSE, fig.show='hold', out.height="45%", out.width="45%", fig.align='center'}
plot(ts.dar,pch = 20, main = "Residui della decomposizione additiva")
plot(ts.dmr,pch = 20, main = "Logaritmo dei residui della decomposizione moltiplicativa")
```

Effettivamente i residui hanno un ordine di grandezza pari a $10^4$, solo pochi sono dell’ordine di $10^5$. Quindi
sia nella decomposizione additiva che in quella moltiplicativa non riusciamo a catturare sufficientemente
bene la stagionalità, in quanto in ambedue i casi gli ordini di grandezza sono comparabili (in questo caso
addirittura gli stessi).


Dato che entrambe le decomposizioni a stagionalità fissa non restituiscono risultati convincenti, proviamo a
decomporre la serie storica con il metodo a stagionalità variabile.

```{r echo=FALSE, fig.show='hold', out.height="45%", out.width="45%", fig.align='center'}
ts.stl = stl(ts[,1], 7)
plot(ts.stl)
plot(ts.stl$time.series[,3], main = "Serie dei residui")
```

Ci troviamo sostanzialmente nella stessa situazione di prima, anche in questo caso non abbiamo un risultato
convincente, nel senso che non riusciamo a catturare sufficientemente bene la stagionalità. Non crediamo che
la stagionalità sia trascurabile visto anche l’aspetto della funzione di autocorrelazione della serie.

\section{Holt Winters}
Consideriamo adesso il metodo di Holt-Winters e confrontiamo il metodo di HW additivo e il metodo moltiplicativo, per capire quale dei due funziona meglio per la serie storica in esame. Riportiamo in seguito una rappresentazione grafica dei due metodi con coefficienti di default (i.e. i coefficienti ottimali ottenuti minimizzando la varianza dei residui) e i valori di tali coefficienti.

```{r echo=FALSE, fig.show='hold', out.height="45%", out.width="45%", fig.align='center'}
ts.plot(ts,ts.hwa$fitted[,1],col=c("black","red"), main = "Holt-Winters additivo")
ts.plot(ts,ts.hwm$fitted[,1],col=c("black","red"), main = "Holt-Winters moltiplicativo")
```

```{r echo=FALSE}
C = matrix(nrow = 4, ncol = 3)
C[,1] = c(" ", "alpha", "beta", "gamma")
C[1, 2] = "HW Additivo"
C[1, 3] = "HW Moltiplicativo"
C[2,2] = ts.hwa$alpha
C[2,3] = ts.hwm$alpha
C[3,2] = ts.hwa$beta
C[3,3] = ts.hwm$beta
C[4,2] = ts.hwa$gamma
C[4,3] = ts.hwm$gamma
knitr::kable(C, format="markdown")
```

Facciamo alcune osservazioni sui coefficienti.
\begin{itemize}
\item Il valore di alpha è molto grande per entrambi i metodi (circa 0.6) e quindi ambedue i metodi prediligono la componente innovativa: infatti questo si vede anche dai plot delle due serie generate, entrambe seguono molto la serie originale.
\item Il valore di beta è molto basso per entrambi i metodi (circa 0.01): questo è molto ragionevole, data la forma che ha il trend, vista nella sezione Decomposizione ("oscilla poco").
\item Il valore di gamma è molto vicino a 0.5 per entrambi i metodi (più per il metodo moltiplicativo).
\end{itemize}

Guardando i plot e le osservazioni fatte poc'anzi entrambi i metodi (sia additivo che moltiplicativo) sembrano catturare già bene la struttura della serie storica in esame, soprattutto nella parte finale (che è la più interessante per la predizione). 
Confrontiamo adesso i due metodi analizzandone in dettaglio i residui

```{r echo=FALSE, fig.show='hold', out.height="35%", out.width="35%", fig.align='center'}
ts.hwa.r=resid(ts.hwa)
ts.hwm.r=resid(ts.hwm)
vra =var(ts.hwa.r)/var(window(ts,2000))
vrm =var(ts.hwm.r)/var(window(ts,2000))
cat("Varianza non spiegata HW additivo:", vra)
cat("Varianza non spiegata HW moltiplicativo:", vrm)
plot(ts.hwa.r, type = "p", pch = 20, main = "Rappresentazione grafica residui HW-a rispetto al tempo")
plot(ts.hwm.r, type = "p", pch = 20, main = "Rappresentazione grafica residui HW-m rispetto al tempo")

```

```{r echo=FALSE, fig.show='hold', out.height="35%", out.width="35%", fig.align='center'}
plot(as.numeric(ts.hwa$fitted[,1]),as.numeric(ts.hwa.r),type="p",pch=20, main = "Rappresentazione grafica residui HW-a rispetto ai valori stimati")
plot(as.numeric(ts.hwm$fitted[,1]),as.numeric(ts.hwm.r),type="p",pch=20, main = "Rappresentazione grafica residui HW-a rispetto ai valori stimati")
```

```{r echo=FALSE, fig.show='hold', out.height="35%", out.width="35%", fig.align='center'}
acf(ts.hwa.r, main = "ACF residui HW-a")
acf(ts.hwm.r, main = "ACF residui HW-m")
```

Entrambi i metodi hanno una struttura molto simile dei residui. Inoltre, guardando le funzioni di autocorrelazione osserviamo che entrambi i metodi riescono a catturare sufficientemente bene le informazioni su trend e stagionalità della serie, poichè per ogni lag (eccetto, ovviamente, lag = 0) la ACF non è significativamente diversa da 0.
Ambedue presentano una proporzione di varianza non spiegata molto bassa (leggerissimamente meglio HW-a).

Procediamo la nostra analisi dei due metodi di HW confrontando le loro capacità predittive: per farlo valutiamo l'errore nella predizione per 2 anni tramite un procedimento di autovalutazione.   

```{r echo=FALSE, fig.show='hold', out.height="50%", out.width="50%", fig.align='center'}
cat("Varianza dell'errore nel metodo additivo (in blu):", sqrt(mean(res.hwa^2)))
cat("Varianza dell'errore nel metodo moltiplicativo (in verde):", sqrt(mean(res.hwm^2)))
plot(res.hwa,type="b",pch=20,col="blue", main = "Errore nella predizione (24 mesi)")
lines(res.hwm,type="b",pch=20,col="green3")
```

Possiamo fare alcune osservazioni.

\begin{enumerate}
\item Negli ultimi due anni i valori della serie sono dell'ordine di $10^6$ e per entrambi i metodi abbiamo una varianza dell'errore pari a circa $2 \times 10^4$, quindi entrambi i metodi hanno un'incertezza sulla previsione pari a circa il 2%.
\item Tra i due preferiamo il metodo di HW additivo, sia perchè ha una varianza dell'errore leggermente più bassa sia perchè il metodo di HW moltiplicativo ha problemi di convergenza nel dodicesimo mese di validazione (come si vede facilmente dal plot).
\end{enumerate}

Concludiamo dalla nostra analisi che il metodo di Holt-Winters additivo si comporta meglio di quello moltiplicativo.

















